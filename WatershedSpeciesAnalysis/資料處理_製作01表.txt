
library(shiny)
library(DT)

# 定義 UI
ui <- fluidPage(
  titlePanel("CSV Viewer with Column Selection"),
  
  # 上傳 CSV 檔案
  fileInput("file", "Choose CSV File",
            accept = c("text/csv", "text/comma-separated-values,text/plain", ".csv")),
  
  # 下拉式選單，用於選擇河川名稱
  selectInput("river_select", "Select River", NULL),
  
  # 下拉式選單，用於選擇物種
  selectInput("species_select", "Select Species", NULL),
  
  # 顯示表格
  DTOutput("table"),
  
  # 顯示不同的物種
  verbatimTextOutput("unique_species"),
  
  # 顯示所有不同的河川
  verbatimTextOutput("unique_rivers"),
  
  # 顯示二維表格
  DTOutput("binary_matrix"),
  
  # 新增儲存按鈕
  downloadButton("save_button", "Save Binary Matrix"),
  
)

# 定義 server 邏輯
server <- function(input, output, session) {
  
  # 創建一個 reactiveVal 用於儲存二維表格的資料
  binary_df <- reactiveVal(NULL)
  
  # 讀取 CSV 檔案
  data <- reactive({
    req(input$file)  # 確保檔案已經被選取
    read.csv(input$file$datapath)
  })
  
  # 更新下拉式選單的選項
  observe({
    col_options <- names(data())
    updateSelectInput(session, "river_select", choices = col_options)
    updateSelectInput(session, "species_select", choices = col_options)
  })
  
  # 選擇河川名稱和物種的資料
  selected_data <- reactive({
    req(input$river_select, input$species_select)
    data_selected <- data()[, c(input$river_select, input$species_select), drop = FALSE]
    colnames(data_selected) <- c("River", "Species")
    data_selected
  })
  
  # 顯示選擇的列
  output$table <- renderDT({
    datatable(selected_data())
  })
  
  # 取得物種那一列的所有不同值
  output$unique_species <- renderPrint({
    unique_species <- unique(selected_data()$Species)
    cat("Unique Species: ", paste(unique_species, collapse = ", "))
  })
  
  # 取得河川那一列的所有不同值
  output$unique_rivers <- renderPrint({
    unique_rivers <- unique(selected_data()$River)
    cat("Unique Rivers: ", paste(unique_rivers, collapse = ", "))
  })
  
  # 顯示二維表格
  output$binary_matrix <- renderDT({
    # 創建二維表格
    binary_matrix <- table(selected_data()$River, selected_data()$Species)
    
    # 將大於1的數字都改成1
    binary_matrix[binary_matrix > 1] <- 1
    
    # 轉換成資料框
    binary_df_data <- as.data.frame.matrix(binary_matrix)
    
    # 將資料儲存在 reactiveVal 中
    binary_df(binary_df_data)
    
    # 顯示表格
    datatable(binary_df_data)
  })
  
  # 增加儲存按鈕的功能
  output$save_button <- downloadHandler(
    filename = function() {
      paste("binary_matrix_", Sys.Date(), ".csv", sep = "")
    },
    content = function(file) {
      # 儲存二維表格為 CSV 檔案
      write.csv(binary_df(), file, row.names = TRUE)
    }
  )
  
}

# 執行應用程式
shinyApp(ui = ui, server = server)